---
layout: page
title: Exception methods can bypass $SAFE
---

Exception#to_s method can be used to trick $SAFE check, which makes a untrusted codes to modify arbitrary strings. 
<div id="extended">
<h3>Detailed description</h3>

<p>In Ruby's $SAFE semantics, safe level of 4 is used to run a untrusted code (such as plugin).  So in upper safe levels, some sort of operations are prohibited to prevent untrusted codes from attacking outer (trusted) data.</p>

<p>Exception#to_s was found to be problematic around it.  The method can trick safe level mechanism and destructively modifies an untaitned string to be tainted.  With this an attacker can modify arbitrary untainted strings like this:</p>

<pre><code>$secret_path = "foo"

proc do
    $SAFE = 4
    Exception.new($secret_path).to_s
    $secret_path.replace "/etc/passwd"
end.call

open($secret_path) do
  ...
end
</code></pre>

<h3>Affected versions</h3>

<p>Luckily this attack is ineffective for 1.9.x series of ruby.  Affected versions are restricted to:</p>

<ul>
<li>Ruby 1.8.6 patchlevel 420 and all prior versions</li>
<li>Ruby 1.8.7 patchlevel 330 and all prior versions</li>
<li>Development versions of Ruby 1.8 (1.8.8dev)</li>
</ul>
<h3>Solutions</h3>

<p>Please upgrade to a newer version.</p>

<h3>Updates</h3>

<ul>
<li>1.8.7-334 was released to fix this issue.
1.8.7 users are encouraged to upgrade.
<ul>
<li><a href="ftp://ftp.ruby-lang.org/pub/ruby/1.8/ruby-1.8.7-p334.tar.gz">ftp://ftp.ruby-lang.org/pub/ruby/1.8/ruby-1.8.7-p334.tar.gz</a></li>
<li><a href="ftp://ftp.ruby-lang.org/pub/ruby/1.8/ruby-1.8.7-p334.tar.bz2">ftp://ftp.ruby-lang.org/pub/ruby/1.8/ruby-1.8.7-p334.tar.bz2</a></li>
<li><a href="ftp://ftp.ruby-lang.org/pub/ruby/1.8/ruby-1.8.7-p334.zip">ftp://ftp.ruby-lang.org/pub/ruby/1.8/ruby-1.8.7-p334.zip</a></li>
</ul>
</li>
</ul>
</div>
            
